# AI_RECOMENDATIONS.md - Внутреннее руководство для Gemini CLI Agent

Этот документ служит кратким руководством для Gemini CLI Agent при работе над проектом `base_app`. Он суммирует архитектуру проекта, ключевые технологии и основные рабочие процессы для обеспечения последовательных и корректных модификаций.

## 1. Обзор проекта

-   **Тип**: Шаблон веб-приложения на Go с Чистой Архитектурой, полным стеком наблюдаемости и встроенным фронтендом на Vue.js.
-   **Бэкенд**: Go (1.19+), роутер `chi`, сессии `scs`, логирование `slog`.
-   **Фронтенд**: Vue.js (без системы сборки), динамические компоненты загружаются через `fetch`.
-   **База данных**: PostgreSQL, управляется `sqlc`.
-   **API**: RESTful, определяется OpenAPI 3.0, генерируется `ogen`.
-   **Наблюдаемость**: EFK (Elasticsearch, Filebeat, Kibana) для логов, Prometheus/Grafana для метрик (базовая настройка), GlitchTip (совместимый с Sentry) для отслеживания ошибок.
-   **Контейнеризация**: Docker Compose для всех сервисов.

## 2. Ключевые архитектурные паттерны и технологии

-   **Чистая Архитектура**: Слои: `handler` (HTTP) -> `usecase` (Бизнес-логика) -> `service` (Доменные сервисы) -> `adapter` (Репозиторий/Внешние системы).
-   **Генерация кода**:
    -   **API**: `ogen` генерирует HTTP-сервер, интерфейсы и типы из `contracts/http/v1/base_app.yaml`.
    -   **База данных**: `sqlc` генерирует Go-код для доступа к базе данных из SQL-запросов (`.sql` файлов) в `internal/adapter/repository/postgresql/sql/`.
-   **Загрузка компонентов фронтенда**: Компоненты Vue.js загружаются динамически через `fetch` из `.html` файлов в `cmd/app/web/components/`. Основной экземпляр `App` передает все свое состояние как проп `appState` этим компонентам.
-   **Управление сессиями**: Библиотека `scs` с хранилищем Redis (если включено), использующая аутентификацию на основе cookie. Вызовы `fetch` на фронтенде *должны* включать `credentials: 'include'`.
-   **Конфигурация**: `configs/config.yaml` с локальными переопределениями в `configs/config.local.yaml`.

## 3. Основные команды и чек-лист рабочего процесса

Всегда запускайте `make check-all` после любых значительных изменений.

### 3.1. Начальная настройка и запуск

1.  **Запуск инфраструктуры**: `make docker-up`
2.  **Выполнение миграций**: `make run-prepare`
3.  **Генерация кода**: `make generate` (для API), `make gen-sqlc` (для БД)
4.  **Запуск приложения**: `make run-local` (для локальной разработки с `config.local.yaml`)
5.  **Доступ к фронтенду**: `http://localhost:8080/`

### 3.2. Изменение API (спецификация OpenAPI)

1.  **Редактирование спецификации**: Измените `contracts/http/v1/base_app.yaml`.
2.  **Перегенерация**: Запустите `make generate`.
3.  **Реализация обработчика**: Обновите `internal/handler/http/handler_impl.go`, чтобы реализовать новые/измененные методы интерфейса `v1.Handler`.
4.  **Реализация UseCase/Сервиса**: Добавьте/измените бизнес-логику в слоях `usecase` и `service`.
5.  **Проверка**: Запустите `make check-all`.

### 3.3. Изменение базы данных (схема или запросы)

1.  **Изменение схемы (при необходимости)**: Создайте новый файл миграции в `contracts/pgsql/migrations/`.
2.  **Написание запроса**: Добавьте новый именованный SQL-запрос в `.sql` файл в `internal/adapter/repository/postgresql/sql/`.
3.  **Перегенерация**: Запустите `make gen-sqlc`.
4.  **Реализация метода репозитория**: Обновите `internal/adapter/repository/postgresql/repo.go`, чтобы использовать новые/измененные методы, сгенерированные `sqlc`.
5.  **Проверка**: Запустите `make check-all`.

### 3.4. Управление зависимостями Go

1.  **Добавление/обновление зависимости**: Используйте `go get <package>` или измените `go.mod`.
2.  **Очистка и вендоринг**: Всегда запускайте `go mod tidy && go mod vendor`.
3.  **Проверка**: Запустите `make check-all`.

### 3.5. Изменения фронтенда

1.  **HTML-шаблоны**: Измените файлы в `cmd/app/web/components/`. Помните, что они получают проп `appState`.
2.  **Логика JavaScript**: Измените `cmd/app/web/app.js`. Убедитесь, что вызовы `fetch` включают `credentials: 'include'` для аутентифицированных эндпоинтов.
3.  **CSS**: Измените `cmd/app/web/style.css`.
4.  **Проверка**: Очистите кэш браузера и обновите страницу.

### 3.6. Общий чек-лист проверки

Прежде чем считать задачу выполненной:

-   **Сборка**: Успешно ли выполняется `make build`?
-   **Тесты**: Проходят ли `make test`? (Примечание: В настоящее время для большинства пакетов нет тестовых файлов, поэтому это в основном проверяет компиляцию).
-   **Линтинг**: Сообщает ли `make lint` 0 проблем?
-   **Vet**: Сообщает ли `make vet` 0 проблем?
-   **Генерация кода**: Были ли запущены `make generate` и `make gen-sqlc`, если изменились контракты API/БД?
-   **Зависимости**: Были ли запущены `go mod tidy && go mod vendor`, если изменились зависимости?
-   **Функциональность**: Работает ли приложение (`make run-local`) и выполняет ли функция ожидаемые действия?
-   **Кэш фронтенда**: Всегда советуйте пользователю очищать кэш браузера после изменений фронтенда.

## 4. Распространенные ошибки и советы по отладке

-   **Ошибки `undefined` в Go**: Часто это несоответствие типов, отсутствующий импорт или некорректное определение структуры/интерфейса. Внимательно проверяйте интерфейсы `usecase` и `service`.
-   **`cannot find module ... -mod=vendor`**: Запустите `go mod tidy && go mod vendor`.
-   **Проблемы с генерацией `ogen` / `sqlc`**: Проверьте пути в `config.yaml`, команды `Makefile` и синтаксис `.sql` / `.yaml`.
-   **Фронтенд `401 Unauthorized`**: Убедитесь, что `credentials: 'include'` включен в вызовах `fetch` и имя cookie сессии соответствует конфигурации `ogen`.
-   **Фронтенд `TypeError`**: Обычно это проблема области видимости компонента. Убедитесь, что данные/методы передаются через проп `appState` и доступны как `appState.property`.
-   **`make` не перегенерирует**: Вручную удалите сгенерированные файлы или убедитесь, что цели `Makefile` указаны правильно.

Следуя этому руководству, я смогу эффективно и точно выполнять будущие задачи по этому проекту.
