# Base App - Go Clean Architecture & Code Generation

This Go application serves as a production-ready template demonstrating a blend of Clean Architecture, a full observability stack, and a contract-first approach to API and database development using code generation.

## ‚ú® Features

- **Clean Architecture**: A clear separation of concerns with distinct layers (`handler`, `usecase`, `service`, `adapter`) for high maintainability and testability.
- **Contract-First API**: The REST API is defined by an OpenAPI 3.0 specification. The server, interfaces, and data types are generated by **[ogen](https://github.com/ogen-go/ogen)**, ensuring the implementation always matches the contract.
- **Contract-First Database**: The database layer is managed by **[sqlc](https://github.com/sqlc-dev/sqlc)**. SQL queries are the source of truth, from which sqlc generates type-safe Go code for database access.
- **Full Docker Integration**: The entire infrastructure (PostgreSQL, Redis, EFK for logging, Prometheus/Grafana for metrics, GlitchTip for error tracking) is containerized and managed with a single `docker-compose.yml` file.
- **Observability Stack**:
  - **Logging (EFK)**: Application logs are collected by **Filebeat**, stored in **Elasticsearch**, and are searchable/visualizable in **Kibana**.
  - **Metrics (Prometheus & Grafana)**: The application is set up to be scraped by Prometheus (though no custom metrics are implemented yet).
  - **Error Tracking (GlitchTip)**: The application uses the Sentry SDK to report errors and panics to a self-hosted, Sentry-compatible instance of **GlitchTip**.
- **Embedded Frontend**: A simple, dependency-free Vue.js single-page application is embedded into the Go binary and served from the root.

## üèóÔ∏è Architecture

The project follows a Clean Architecture philosophy, with dependencies pointing inwards.

- `cmd/app/main.go`: The application's entry point, responsible for dependency injection.
- `configs/`: YAML configuration files.
- `contracts/`: The "contracts" or sources of truth.
  - `http/v1/base_app.yaml`: The OpenAPI specification.
  - `pgsql/migrations/`: SQL database migration files.
  - `pgsql/sqlc/config.yaml`: The configuration for sqlc.
- `internal/`: All core application logic.
  - `handler/http/`: Contains the HTTP handler implementation that satisfies the `ogen`-generated interface.
  - `handler/http/v1/`: **(Generated)** Code generated by `ogen`.
  - `usecase/`: Defines the application's business logic and use cases.
  - `service/`: Implements domain services (logic shared between use cases).
  - `adapter/repository/postgresql/`: The database adapter layer.
    - `sql/`: Contains the raw SQL queries for `sqlc`.
    - `sqlc/`: **(Generated)** Code generated by `sqlc`.
    - `repo.go`: The implementation of the repository interfaces, using the code generated by `sqlc`.
- `pkg/`: Shared, business-logic-agnostic packages (e.g., logger).
- `scripts/`: Utility and initialization scripts (e.g., `init-db.sh` for Docker).

## üöÄ Getting Started

### 1. Prerequisites
- Docker & Docker Compose
- Go 1.19+
- `make`
- `sqlc` and `ogen` Go tools (they will be installed if missing)

### 2. Configuration
Copy the example local config and customize if needed. The default values are set up to work with the provided `docker-compose.yml`.
```bash
cp configs/config.local.yaml.example configs/config.local.yaml
```
**Important**: After the first run, you will need to get the DSN key from GlitchTip and add it to `config.local.yaml`. See the "Observability" section for details.

### 3. Launch Infrastructure
This single command will start PostgreSQL, Redis, and the entire observability stack. It will also auto-create the `app_db` and `glitchtip_db` databases on the first run.
```bash
make docker-up
```
*The first launch can take a few minutes as Docker downloads all the images.*

### 4. Run Database Migrations
This command runs the Go application in a special "Prepare" mode, which applies all SQL migrations to the `app_db` database.
```bash
make run-prepare
```

### 5. Generate Code
The project relies on generated code. Run the generators for both the API and the database layer.
```bash
make generate
make gen-sqlc
```

### 6. Run the Application
Now, run the application using the local configuration.
```bash
make run-local
```
The backend server will be available at `http://localhost:8080`.

### 7. Access the Frontend
The embedded Vue.js frontend is served from the root URL.
- **URL**: `http://localhost:8080/`

## üíª Development Workflow

This project uses a code-generation-heavy workflow. This is the key to maintaining consistency between the API contract, database schema, and the Go code.

### Adding a New API Endpoint
1.  **Edit the Contract**: Add or modify the endpoint in `contracts/http/v1/base_app.yaml`.
2.  **Regenerate**: Run `make generate`. This updates the `Handler` interface in `internal/handler/http/v1/oas_interfaces_gen.go`.
3.  **Implement the Handler**: Add the new method to the `Handler` struct in `internal/handler/http/handler_impl.go`. The Go compiler will tell you if you've missed anything.
4.  **Add Business Logic**: Implement the corresponding logic in the appropriate `usecase`.

### Adding a New Database Query
1.  **Write the Migration (if needed)**: If you are changing the schema, add a new migration file in `contracts/pgsql/migrations/`.
2.  **Write the Query**: Add the new named SQL query to a `.sql` file in `internal/adapter/repository/postgresql/sql/`.
3.  **Regenerate**: Run `make gen-sqlc`. This updates the `Querier` interface and adds a new method in `internal/adapter/repository/postgresql/sqlc/`.
4.  **Implement the Repository Method**: Add or modify the method in `internal/adapter/repository/postgresql/repo.go` that calls the newly generated `sqlc` method.

### General Checklist
After any significant change, and especially after adding a dependency, run the following commands:
1.  `go mod tidy`
2.  `go mod vendor`
3.  `make check-all` (This runs tests, linters, and code generators)

## ‚öôÔ∏è Observability Stack

- **Kibana** (Logs): `http://localhost:5601`
- **Grafana** (Dashboards): `http://localhost:3000`
- **Prometheus** (Metrics): `http://localhost:9090`
- **GlitchTip** (Error Tracking): `http://localhost:8000`

### GlitchTip DSN Setup
1.  After `make docker-up`, navigate to `http://localhost:8000`.
2.  The first time, it will ask you to create an admin account.
3.  A default organization ("Default") and project ("BaseApp") are created automatically.
4.  Click on the `BaseApp` project.
5.  In the left sidebar, go to `Settings`.
6.  Under "Client Keys (DSN)", copy the DSN value.
7.  Paste this value into your `configs/config.local.yaml` under `sentry.dsn`.
8.  Restart the Go application (`make run-local`) for the changes to take effect.

## Makefile Commands

- `make build`: Build the Go application binary.
- `make run`: Run the application with the default config.
- `make run-local`: Run with `config.local.yaml`.
- `make run-prepare`: Apply database migrations.
- `make generate`: Regenerate API code (`ogen`).
- `make gen-sqlc`: Regenerate database code (`sqlc`).
- `make test`: Run Go tests.
- `make lint`: Run `golangci-lint`.
- `make vet`: Run `go vet`.
- `make check-all`: Run tests, linters, vet, and sqlc generation.
- `make docker-up`: Start all Docker services.
- `make docker-down`: Stop and remove all Docker services.