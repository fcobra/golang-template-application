# AI_RECOMENDATIONS.md - Internal Guide for Gemini CLI Agent

This document serves as a concise guide for the Gemini CLI Agent when working on the `base_app` project. It summarizes the project's architecture, key technologies, and essential workflows to ensure consistent and correct modifications.

## 1. Project Overview

-   **Type**: Go web application template with Clean Architecture, full observability stack, and an embedded Vue.js frontend.
-   **Backend**: Go (1.19+), `chi` router, `scs` sessions, `slog` logging.
-   **Frontend**: Vue.js (no build system), dynamic components loaded via `fetch`.
-   **Database**: PostgreSQL, managed by `sqlc`.
-   **API**: RESTful, defined by OpenAPI 3.0, generated by `ogen`.
-   **Observability**: EFK (Elasticsearch, Filebeat, Kibana) for logs, Prometheus/Grafana for metrics (basic setup), GlitchTip (Sentry-compatible) for error tracking.
-   **Containerization**: Docker Compose for all services.

## 2. Key Architectural Patterns & Technologies

-   **Clean Architecture**: Layers: `handler` (HTTP) -> `usecase` (Business Logic) -> `service` (Domain Services) -> `adapter` (Repository/External).
-   **Code Generation**:
    -   **API**: `ogen` generates HTTP server, interfaces, and types from `contracts/http/v1/base_app.yaml`.
    -   **Database**: `sqlc` generates Go code for database access from `.sql` queries in `internal/adapter/repository/postgresql/sql/`.
-   **Frontend Component Loading**: Vue.js components are loaded dynamically via `fetch` from `.html` files in `cmd/app/web/components/`. The main `App` instance passes its entire state as `appState` prop to these components.
-   **Session Management**: `scs` library with Redis store (if enabled), using cookie-based authentication. Frontend `fetch` calls *must* include `credentials: 'include'`.
-   **Configuration**: `configs/config.yaml` with local overrides in `configs/config.local.yaml`.

## 3. Essential Commands & Workflow Checklist

Always run `make check-all` after any significant change.

### 3.1. Initial Setup & Running

1.  **Start Infrastructure**: `make docker-up`
2.  **Run Migrations**: `make run-prepare`
3.  **Generate Code**: `make generate` (for API), `make gen-sqlc` (for DB)
4.  **Run App**: `make run-local` (for local development with `config.local.yaml`)
5.  **Access Frontend**: `http://localhost:8080/`

### 3.2. Modifying the API (OpenAPI Spec)

1.  **Edit Spec**: Modify `contracts/http/v1/base_app.yaml`.
2.  **Generate Code**: Run `make generate`.
3.  **Implement Handler**: Update `internal/handler/http/handler_impl.go` to implement new/modified methods of the `v1.Handler` interface.
4.  **Implement Usecase/Service**: Add/modify business logic in `usecase` and `service` layers.
5.  **Verify**: Run `make check-all`.

### 3.3. Modifying the Database (Schema or Queries)

1.  **Schema Change**: Create a new migration file in `contracts/pgsql/migrations/`.
2.  **Query Change**: Add/modify `.sql` files in `internal/adapter/repository/postgresql/sql/`.
3.  **Generate Code**: Run `make gen-sqlc`.
4.  **Implement Repository**: Update `internal/adapter/repository/postgresql/repo.go` to use new/modified `sqlc`-generated methods.
5.  **Verify**: Run `make check-all`.

### 3.4. Managing Go Dependencies

1.  **Add/Update Dependency**: Use `go get <package>` or modify `go.mod`.
2.  **Clean & Vendor**: Always run `go mod tidy && go mod vendor`.
3.  **Verify**: Run `make check-all`.

### 3.5. Frontend Changes

1.  **HTML Templates**: Modify files in `cmd/app/web/components/`. Remember they receive `appState` prop.
2.  **JavaScript Logic**: Modify `cmd/app/web/app.js`. Ensure `fetch` calls include `credentials: 'include'` for authenticated endpoints.
3.  **CSS**: Modify `cmd/app/web/style.css`.
4.  **Verify**: Clear browser cache and refresh.

### 3.6. General Verification Checklist

Before considering any task complete:

-   **Build**: Does `make build` succeed?
-   **Tests**: Do `make test` pass? (Note: Currently no test files exist for most packages, so this will mostly check compilation).
-   **Linting**: Does `make lint` report 0 issues?
-   **Vet**: Does `make vet` report 0 issues?
-   **Code Generation**: Have `make generate` and `make gen-sqlc` been run if API/DB contracts changed?
-   **Dependencies**: Have `go mod tidy && go mod vendor` been run if dependencies changed?
-   **Functionality**: Does the application run (`make run-local`) and does the feature work as expected?
-   **Frontend Cache**: Always advise the user to clear their browser cache after frontend changes.

## 4. Common Pitfalls & Debugging Tips

-   **`undefined` errors in Go**: Often a type mismatch, missing import, or incorrect struct/interface definition. Check `usecase` and `service` interfaces carefully.
-   **`cannot find module ... -mod=vendor`**: Run `go mod tidy && go mod vendor`.
-   **`ogen` / `sqlc` generation issues**: Check `config.yaml` paths, `Makefile` commands, and the `.sql` / `.yaml` syntax.
-   **Frontend `401 Unauthorized`**: Ensure `credentials: 'include'` is on `fetch` calls and `session` cookie name matches `ogen` config.
-   **Frontend `TypeError`**: Usually a component scope issue. Ensure data/methods are passed via `appState` prop and accessed as `appState.property`.
-   **`make` not regenerating**: Manually `rm` generated files or ensure `Makefile` targets are correct.

By following this guide, I should be able to efficiently and accurately perform future tasks on this project.
